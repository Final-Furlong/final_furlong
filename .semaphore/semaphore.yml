version: v1.0
name: Final Furlong CI
agent:
  machine:
    type: e1-standard-2
    os_image: ubuntu2004
auto_cancel:
  running:
    when: branch != 'master'
  queued:
    when: branch = 'master'
global_job_config:
  prologue:
    commands:
      - checkout
      - sem-version ruby 3.4.2
      - install-package libc6
  epilogue:
    always:
      commands:
        - '[[ -f report.xml ]] && test-results publish report.xml'
  env_vars:
    - name: MAILTRAP_API_KEY
      value: foo
    - name: RAILS_ENV
      value: test
    - name: COVERAGE
      value: 'true'
    - name: EXTERNAL_CI
      value: 'true'
    - name: DATABASE_URL
      value: postgresql://postgres:@0.0.0.0:5432/final_furlong_test
    - name: CACHE_DATABASE_URL
      value: postgresql://postgres:@0.0.0.0:5432/final_furlong_test_cache
    - name: QUEUE_DATABASE_URL
      value: postgresql://postgres:@0.0.0.0:5432/final_furlong_test_queue
blocks:
  - name: CI
    dependencies: [ ]
    task:
      prologue:
        commands:
          - sem-service start postgres 17.6
          - sem-service start mysql 8 --username=developer --password=password --db=final_furlong_legacy_test
          - cache restore
          - bundle config set deployment true
          - bundle config set path vendor/bundle
          - bundle install
          - yarn install
          - cache store
          - cp config/database.yml.github_actions config/database.yml
          - bin/rails db:create:primary db:schema:load:primary
          - bin/rails db:create:queue db:schema:load:queue
          - bin/rails db:create:cache db:schema:load:cache
      jobs:
        - name: Run Linters
          env_vars:
            - name: CI_TYPE
              value: style
          commands:
            - bin/ci
        - name: Security Checks
          env_vars:
            - name: CI_TYPE
              value: security
          commands:
            - bin/ci
        - name: Performance Checks
          env_vars:
            - name: CI_TYPE
              value: performance
          commands:
            - bin/ci
        - name: Tests
          env_vars:
            - name: CI_TYPE
              value: tests
          commands:
            - bin/ci
            - .semaphore/lcov-to-md.sh
            - artifact push workflow -d .semaphore/REPORT.md COVERAGE.md
            - artifact push job tmp/capybara; return 0
            - ruby -e "$(curl -s https://undercover-ci.com/uploader.rb)" -- --repo $SEMAPHORE_GIT_REPO_SLUG --commit $SEMAPHORE_GIT_PR_SHA --simplecov coverage/coverage.json; return 0
            - curl https://qlty.sh | sh
            - source /home/semaphore/.bash_profile
            - qlty coverage publish coverage/lcov.info
      secrets:
        - name: Qlty Code Coverage
  - name: Reports
    dependencies:
      - CI
    task:
      jobs:
        - name: Merge reports
          commands:
            - test-results gen-pipeline-report
